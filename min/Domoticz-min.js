function Domoticz(e){this.server=e,this.rooms={},this.devices={},this.scenes={},this.inProgress=!1,this.updateInterval=5,this.init()}Domoticz.prototype.init=function(){this.getRooms().then(this.getDevices()).then(this.getScenes()).then(function(){Vue.nextTick(function(){init()})}),setInterval(function(){this.getDevices()}.bind(this),1e3*this.updateInterval)},Domoticz.prototype.getRooms=function(){var e=$.Deferred(),t=this.server+"/json.htm?type=plans&order=name&used=true",i={};return $.get(t,function(t){if("OK"!=t.status)return e.reject(),null;for(var s=0;s<t.result.length;s++){var n=t.result[s];i[n.idx]={name:n.Name,filename:n.Name.toLowerCase().replace(/\s+/g,""),scenes:[]}}return this.rooms=i,e.resolve(),!0}.bind(this)),e},Domoticz.prototype.getDevices=function(){this.inProgress=!0;var e=$.Deferred(),t=this.server+"/json.htm?type=devices&filter=light&used=true&order=Name",i={};return $.get(t,function(t){if("OK"!=t.status)return e.reject(),null;for(var s=0;s<t.result.length;s++){var n=t.result[s];if("Scene"!=n.Type){var o={};if(o.name=n.Name,o.idx=n.idx,o.status=n.Status,o.name.toLowerCase().indexOf("fan")>-1?o.icon="fan":o.icon="lightbulb",0==n.PlanID&&!this.rooms[0]){var r={name:"Default Room",filename:"default",scenes:[]};this.rooms[0]=r}"Dimmer"==n.SwitchType&&(o.dimmer=!0,o.level=n.Level,o.maxLevel=n.MaxDimLevel),o.location=this.rooms[n.PlanID],o.location.id=n.PlanID,"Off"!=o.status?o.on=!0:o.on=!1,i[o.idx]=o}}return this.devices=i,this.inProgress=!1,e.resolve(),!0}.bind(this)),e},Domoticz.prototype.getScenes=function(){var e=$.Deferred(),t=this.server+"/json.htm?type=scenes",i={};return $.get(t,function(t){if("OK"!=t.status)return e.reject(),null;for(var s=0;s<t.result.length;s++){var n=t.result[s];if("Scene"==n.Type){var o={};o.name=n.Name,o.on="On"==n.Status,i[n.idx]=o}}this.scenes=i}.bind(this)).done(function(){e.resolve();var t=[];return $.each(this.scenes,function(e,i){var s=this.server+"/json.htm?type=command&param=getscenedevices&idx="+e+"&isscene=true",n=$.get(s,function(e,t){var i=[];if("OK"!=t.status||!t.result)return null;var s=t.result.map(function(e){return{idx:e.DevRealIdx,on:"Off"!=e.Command}});this.scenes[e].devices=s,s.map(function(t){var s=this.devices[t.idx].location.id;-1==i.indexOf(s)&&(i.push(s),this.rooms[s].scenes.push(e))}.bind(this)),this.scenes[e].rooms=i}.bind(this,e));t.push(n)}.bind(this)),$.when(t)}.bind(this)),e},Domoticz.prototype.checkSceneStatus=function(e){var t=!0,i=this.scenes[e];if(!i.devices)return null;for(var s=0;s<i.devices.length;s++){var n=i.devices[s];if(this.devices[n.idx].on!=n.on){t=!1;break}}this.scenes[e].on=t},Domoticz.prototype.updateScenes=function(e){var t=this.devices[e].location.id;console.log("Updating for room %d",t);var i=this.rooms[t].scenes;i.map(function(e){this.checkSceneStatus(e)}.bind(this))},Domoticz.prototype.toggleDevice=function(e){this.devices[e].on=!this.devices[e].on,this.sendCommand({on:this.devices[e].on},e)},Domoticz.prototype.setDeviceStatus=function(e,t){for(var i in t)this.devices[e][i]=t[i];this.sendCommand(t,e)},Domoticz.prototype.toggleScene=function(e){if(this.scenes[e].on){this.scenes[e].on=!1;var t=this.scenes[e];t.devices.map(function(e){var t={on:!e.on};this.setDeviceStatus(e.idx,t)}.bind(this))}else{this.scenes[e].on=!0,this.sendCommand({sceneOn:!0},e),this.scenes[e].devices.map(function(e){var t=e.idx;this.devices[t].on=e.on}.bind(this));for(var i in this.scenes)this.checkSceneStatus(i)}},Domoticz.prototype.sendCommand=function(e,t){if("on"in e)var i=e.on?"On":"Off",s=this.server+"/json.htm?type=command&param=switchlight&idx="+this.devices[t].idx+"&switchcmd="+i;else if("brightness"in e);else if("sceneOn"in e)var s=this.server+"/json.htm?type=command&param=switchlight&idx="+t+"&switchcmd=On";s&&(console.log(s),$.get(s,function(e){console.log(e)}))},Domoticz.prototype.updateDevices=function(){var e=$.Deferred(),t=this.server+"/json.htm?type=devices&filter=light&used=true&order=Name",i={};return $.get(t,function(t){if("OK"!=t.status)return e.reject(),null;for(var s=0;s<t.result.length;s++){var n=t.result[s];if("Scene"!=n.Type){if(device.name=n.Name,device.idx=n.idx,device.status=n.Status,device.name.toLowerCase().indexOf("fan")>-1?device.icon="fan":device.icon="lightbulb",0==n.PlanID&&!this.rooms[0]){var o={name:"Default Room",filename:"default",scenes:[]};this.rooms[0]=o}"Dimmer"==n.SwitchType&&(device.dimmer=!0,device.level=n.Level,device.maxLevel=n.MaxDimLevel,console.log(device)),device.location=this.rooms[n.PlanID],device.location.id=n.PlanID,"Off"!=device.status?device.on=!0:device.on=!1,i[device.idx]=device}}return this.devices=i,e.resolve(),!0}.bind(this)),e};